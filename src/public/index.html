<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Query Optimization Demo - Job Search</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <h1>SQL Query Optimization Demo</h1>
        <p class="subtitle">Optimized from ~8 seconds to ~38ms (99.27% improvement)</p>
        
        <div class="info-box">
            <h3>About This Demo</h3>
            <ul>
                <li><strong>Problem:</strong> 7 LEFT JOINs create cartesian product (7,200 rows for 240 jobs)</li>
                <li><strong>Solution:</strong> EXISTS subqueries eliminate row multiplication</li>
                <li><strong>Result:</strong> 99.27% faster (136x speed increase)</li>
                <li><strong>Database:</strong> 14 tables, 240 IT jobs (12 types √ó 20 each) with many-to-many relationships</li>
            </ul>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search keyword (e.g., Developer, Software, Database, Cloud)" value="Developer">
            <button class="btn-optimized" onclick="searchOptimized()">‚ö° Optimized Search</button>
            <button class="btn-slow" onclick="searchSlow()">üê¢ Slow Search</button>
            <button class="btn-compare" onclick="compare()">üìä Compare Both</button>
        </div>
        
        <div id="resultsContainer"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchOptimized();
            }
        });
        
        function searchOptimized() {
            const keyword = document.getElementById('searchInput').value;
            document.getElementById('resultsContainer').innerHTML = '<div class="loading">Executing optimized query</div>';
            
            fetch(`${API_BASE}/search/optimized?keyword=${encodeURIComponent(keyword)}`)
                .then(response => response.json())
                .then(data => displayResults(data))
                .catch(error => displayError(error));
        }
        
        function searchSlow() {
            const keyword = document.getElementById('searchInput').value;
            document.getElementById('resultsContainer').innerHTML = '<div class="loading">Executing slow query (this may take several seconds)</div>';
            
            fetch(`${API_BASE}/search/slow?keyword=${encodeURIComponent(keyword)}`)
                .then(response => response.json())
                .then(data => displayResults(data))
                .catch(error => displayError(error));
        }
        
        function compare() {
            const keyword = document.getElementById('searchInput').value;
            document.getElementById('resultsContainer').innerHTML = '<div class="loading">Running both queries for comparison</div>';
            
            fetch(`${API_BASE}/search/compare?keyword=${encodeURIComponent(keyword)}`)
                .then(response => response.json())
                .then(data => displayComparison(data))
                .catch(error => displayError(error));
        }
        
        function displayResults(data) {
            const isFast = data.execution_time_ms < 1000;
            const speedClass = isFast ? 'fast' : 'slow';
            
            let html = `
                <div class="performance-card">
                    <h3>${data.method}</h3>
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-label">Execution Time</div>
                            <div class="stat-value ${speedClass}">${data.execution_time_ms}ms</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Results Found</div>
                            <div class="stat-value neutral">${data.result_count}</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-label">Keyword</div>
                            <div class="stat-value neutral">"${data.keyword}"</div>
                        </div>
                    </div>
                    ${data.note ? `<p style="color: #666; font-style: italic;">Note: ${data.note}</p>` : ''}
                </div>
            `;
            
            if (data.data && data.data.length > 0) {
                html += '<div class="job-list">';
                html += '<h3 style="margin-bottom: 15px;">Search Results:</h3>';
                data.data.forEach(job => {
                    html += `
                        <div class="job-card">
                            <div class="job-title">${job.name}</div>
                            <div class="job-meta">
                                <span class="job-badge badge-category">${job.category_name}</span>
                                <span class="job-badge badge-location">üìç ${job.location}</span>
                                <span class="job-badge badge-salary">üí∞ ${job.salary_range_average}</span>
                            </div>
                            <div class="job-description">${job.description}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            document.getElementById('resultsContainer').innerHTML = html;
        }
        
        function displayComparison(data) {
            const improvement = parseFloat(data.improvement_percentage);
            
            let html = `
                <div class="comparison-result">
                    <h2>‚ö° ${data.speedup_factor}</h2>
                    <div class="comparison-stats">
                        <div class="comparison-stat">
                            <div class="comparison-stat-label">Optimized Query</div>
                            <div class="comparison-stat-value">${data.optimized_time_ms}ms</div>
                        </div>
                        <div class="comparison-stat">
                            <div class="comparison-stat-label">Slow Query</div>
                            <div class="comparison-stat-value">${data.slow_time_ms}ms</div>
                        </div>
                        <div class="comparison-stat">
                            <div class="comparison-stat-label">Improvement</div>
                            <div class="comparison-stat-value">${data.improvement_percentage}</div>
                        </div>
                    </div>
                </div>
                
                <div class="performance-card">
                    <h3>üìà Performance Analysis</h3>
                    <p style="line-height: 1.8; color: #555;">
                        The optimized query using <strong>EXISTS subqueries</strong> is ${data.speedup_factor} than the original 
                        query using <strong>LEFT JOINs with GROUP BY</strong>. This dramatic improvement is achieved by:
                    </p>
                    <ul style="margin-top: 15px; line-height: 1.8; color: #555;">
                        <li>Eliminating cartesian product from multiple LEFT JOINs</li>
                        <li>Removing expensive GROUP BY operation</li>
                        <li>Using EXISTS for efficient early termination</li>
                        <li>Proper indexing on foreign keys and deleted columns</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('resultsContainer').innerHTML = html;
        }
        
        function displayError(error) {
            document.getElementById('resultsContainer').innerHTML = `
                <div class="error">
                    <strong>Error:</strong> ${error.message || 'Failed to fetch data. Make sure the API is running.'}
                </div>
            `;
        }
        
        // Run comparison on page load
        window.addEventListener('load', () => {
            compare();
        });
    </script>
</body>
</html>
